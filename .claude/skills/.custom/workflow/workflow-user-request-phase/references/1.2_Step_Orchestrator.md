# Step 1.2: Orchestrator Initial Dialog

## Role

You are the **orchestrator** in Socratic Dialog Mode.

## Inputs

From step 1.1:
- `user_story_description`: User's initial function description

## Context to Read

1. `constitution.md` - Project principles and constraints
2. `CLAUDE.md` - Orchestrator role and workflow instructions

## Instructions

### 1. Understand User Request

Read the user's initial description and identify:
- Core functionality desired
- Scope (MVP vs full feature)
- Any technical constraints mentioned

### 2. Engage Socratic Dialog (UserApprovalLoop)

**Behavior Mode**: Socratic Dialog Mode

In this mode:
- Ask probing questions to clarify requirements
- Guide user toward clear, concise MVP definition
- User responses may be vague or incorrect - refine iteratively
- Focus on "what" and "why", not "how"

**Loop Structure**:
- Type: `user_approval_loop`
- Max Iterations: Unlimited
- Exit Condition: User approves refined description

**Track Each Iteration**:
```json
{
  "iteration": 1,
  "orchestrator_question": "What's the primary user action?",
  "user_response": "Upload invoice data and generate PDF",
  "refined_description": "Invoice Generator: Upload form data, generate PDF invoice"
}
```

**Sample Questions**:
- "What's the primary user action this function enables?"
- "What's the minimal viable output?"
- "What data inputs are required?"
- "Are there any constraints (auth, permissions, etc.)?"

### 3. Refine Function Metadata

After user approval, extract:
- **name**: Short, descriptive (e.g., "Invoice Generator")
- **description**: 1-2 sentences, clear and concise
- **slug**: URL-safe version of name (e.g., "invoice-generator")

### 4. Create Database Record

Use Supabase MCP tool:

```
@mcp:supabase.insert_row
```

**Parameters**:
```json
{
  "table": "project_functions",
  "schema": "devKit",
  "data": {
    "project_id": "<from-context>",
    "name": "<from-dialog>",
    "description": "<from-dialog>",
    "slug": "<generated>",
    "status_speckit": null,
    "status_agent": "orchestrator"
  }
}
```

Capture returned `id` as `function_id`.

### 5. Fill Checkcard

**Checkcard Location**: `workflow/checkcards/checkcards-1.1-to-2.2.json`

Find checkcard with `step_id: "1.2"` and fill:

```json
{
  "step_id": "1.2",
  "step_name": "Orchestrator Initial Dialog",
  "agent": "orchestrator",
  "behavior_mode": "Socratic Dialog Mode",

  "inputs": {
    "user_story_description": "<from-step-1.1>"
  },

  "context_reads": ["constitution.md", "CLAUDE.md"],

  "loops": {
    "type": "user_approval_loop",
    "max_iterations": null,
    "iterations": 3,
    "loop_data_per_iteration": [
      {
        "iteration": 1,
        "orchestrator_question": "What's the primary user action?",
        "user_response": "Upload invoice data and generate PDF",
        "refined_description": "Invoice Generator: Upload form data, generate PDF invoice"
      },
      {
        "iteration": 2,
        "orchestrator_question": "What data inputs are required?",
        "user_response": "Customer info, line items, totals",
        "refined_description": "Invoice Generator: Input customer details and line items, output PDF invoice"
      },
      {
        "iteration": 3,
        "orchestrator_question": "MVP scope - just PDF generation or also storage?",
        "user_response": "Just PDF generation for now",
        "refined_description": "Invoice Generator: Create PDF invoices from form data (customer info, line items)"
      }
    ],
    "exit_condition": "user approval"
  },

  "database_operations": {
    "create_project_function": {
      "project_id": "abc-123-xyz",
      "name": "Invoice Generator",
      "description": "Create PDF invoices from form data (customer info, line items)",
      "slug": "invoice-generator",
      "status_speckit": null,
      "status_agent": "orchestrator"
    }
  },

  "outputs": {
    "function_id": "550e8400-e29b-41d4-a716-446655440000",
    "function_name": "Invoice Generator",
    "function_description": "Create PDF invoices from form data (customer info, line items)",
    "function_slug": "invoice-generator",
    "agent_spawned": {
      "agent_type": "planner",
      "agent_id": "planner[1.2]",
      "spawned_at": "2025-01-15T10:30:00Z"
    }
  },

  "status": "completed",
  "started_at": "2025-01-15T10:25:00Z",
  "completed_at": "2025-01-15T10:30:00Z",
  "duration_minutes": 5
}
```

### 6. Validate Checkcard

Run validation script to ensure checkcard is complete and correct:

```bash
python references/scripts/validate-checkcard.py \
  references/1.2_Checkcard_Orchestrator.json \
  OrchestratorInitialDialogCheckcard
```

**Validation Loop** (max 3 attempts):

```
+ Start Validation Loop
- Run validation script
- IF validation passes (exit code 0): Exit loop, proceed to step 7
- IF validation fails (exit code 1):
  - Review error messages
  - Fix missing/incorrect fields in checkcard
  - Retry validation
+ Loop End (validation passes OR attempt_count >= 3)

IF attempt_count >= 3 AND validation still failing:
  - Mark checkcard status as "failed"
  - Add validation errors to checkcard.error field
  - Report to orchestrator for manual intervention
  - HALT workflow (do not proceed to step 7)
```

**Common Validation Errors**:

- Missing required fields (e.g., `outputs.function_id`)
- Null values in completed checkcard outputs
- Invalid timestamp format (must be ISO-8601)
- Wrong data types (e.g., string instead of object)
- Missing loop iteration data
- Missing database operation details

### 7. Spawn Planner Agent

**Only proceed if validation passed.**

Execute agent spawn:

```
@agent-spawn:planner[1.2]
```

Provide planner with context:
- function_id
- function_description
- Session context

## Outputs

- **function_id**: UUID from database
- **function_name**: Refined name
- **function_description**: Refined description
- **function_slug**: Generated slug
- **agent_spawned**: planner[1.2] instance info

## Next Step

Planner[1.2] proceeds to step 2.1: Specify Phase
